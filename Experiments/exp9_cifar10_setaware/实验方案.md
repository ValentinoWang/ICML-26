# exp9：CIFAR-10 递归自训练（Set-Aware 抗分布漂移）

> 目标：用最小代价复现“选择偏差”导致的类别坍塌，并用 Set-Aware Filter 稳住最差类别准确率。基线 = Top-K 置信度伪标签，Ours = 观测整批候选集分布后再加权。

## 核心设定
- 任务：CIFAR-10 分类，模型 ResNet-18（从头训练，不用预训练）。
- 标注预算：5% 训练集（每类 250 张，共 2500）作为 Gen0 监督数据；余下 95% 作为无标签候选池。
- 递归代数：5 代，每代新增 2000 张伪标签样本（累计 12.5k），GPU 友好（单卡 4090）。
- 评估：标准 Test Accuracy + 最差类别准确率 (Worst-Class Acc)；同时记录伪标签集合的类别分布/ESS。

## 数据与增广
- Train/Test 按官方划分；Gen0 采样时保证每类 250 张。
- 训练增广：`RandomCrop(32, padding=4)` + `RandomHorizontalFlip` + Normalize(mean/std)；Eval 只做 Normalize。
- 可选简单弱增广用于生成伪标签，避免过强增广带来额外噪声。

## 递归流程
1) **Gen0 训练**：仅用 5% 有标签集训练 ResNet-18，标准 Cross-Entropy，Cosine LR，优化 120 epochs；保存模型 $M_0$。  
2) **候选预测**：用 $M_t$ 对候选池（剩余未选样本）跑前向，得到 logits、最大软概率、伪标签 $\hat{y}$，并缓存倒数第二层特征 $f(x)$。  
3) **选择 / 产生伪标签**：  
   - **Baseline (Top-K Confidence)**：按最大软概率排序，取 2000 个最高置信度样本加入训练集。  
   - **Set-Aware Filter**：以候选集合 $S_t$ 为输入（最多取前 10k–20k 置信度最高样本以控显存），用注意力读取集合分布并输出样本权重 $w$；按 $w$ 重新排序取 Top-2000。通过 $L_{balance}$ 自动平衡类别，避免任何硬性“每类配额”，以免被视为 class-balanced sampling。  
4) **训练 $M_{t+1}$**：在“历史训练集 (标注 + 已采伪标签) + 本代新增 2k”上继续训练/微调 30–50 epochs，MixUp 关闭；可对伪标签样本使用温度校准或置信度阈值（如 p>0.6）。  
5) **评估与日志**：每代记录 Test Acc、Per-Class Acc、Worst-Class Acc，以及本代伪标签的类别直方图、ESS（有效样本量）和平均置信度。

## Set-Aware 过滤器细节（实现建议）
- **特征输入**：使用 `avgpool` 后的 512-d 特征，拼接 (i) 对应伪标签的 one-hot，(ii) 最大软概率，形成候选表示。  
- **模型骨干**：复用 `filter.set_aware.model.SetAwareBiasRobustFilter`（小型 Transformer），输出权重 $w \in [0,1]^n$；校正头 $\Delta \phi$ 暂可忽略或仅作正则。  
- **损失**：  
  - `classification_loss(w, pseudo_y)`：鼓励与伪标签一致但保留低置信样本的可降权空间；  
  - `ess_loss(w, tau)`：防止极端只留单一类别；  
  - 可加入“类别均衡”正则：$L_{balance} = \sum_c (\hat{p}_c - 0.1)^2$，其中 $\hat{p}_c$ 为按 $w$ 加权的类别频率。  
- **训练方式**：每代在候选子集上训练 100–200 步，batch size 1024–2048（集合输入），学习率 1e-3，AdamW；推理时仅前向一次得到 $w$。

## 4090 友好超参（初稿）
- **ResNet-18**：SGD(m=0.9, wd=5e-4)，Gen0 LR 0.1 + Cosine；后续代 LR 0.02，epochs=30–50，batch=256。  
- **伪标签阈值**：Baseline/Ours 共同使用 p>0.6 过滤；若不足 2000，可降到 0.5。  
- **Set-Aware**：hidden=256，heads=4，layers=2，dropout=0.1，`tau`=0.2，`lambda_ess`=0.1，`lambda_balance`=1.0。  
- **Seeds**：默认 3 个（1088, 2195, 4960）；日志写入 `exp9_cifar10_setaware/results/<seed>.json`。

## 预期现象 / 出图
- **Baseline**：总体精度尚可，但伪标签集合迅速被“干净的飞机/汽车”占据；Worst-Class Acc（猫/狗）下滑明显，最终类频高度失衡。  
- **Set-Aware**：通过观察整批分布抑制同质样本，提升少数类权重；Worst-Class Acc 维持在较高水平，类频更平衡。  
- 推荐绘图：每代 Overall/Worst-Class Acc 曲线；伪标签类别直方图；ESS 曲线；必要时展示被拒绝/被保留样本的可视化对照。

## 交付物
- 本实验方案（当前文件）；  
- 运行脚本 `run_exp9_cifar10_setaware.py`（待补）：完成数据拆分、Gen 循环、Baseline vs Set-Aware 对比、日志与绘图；  
- 结果文件：`results/*.json|csv|png`。
